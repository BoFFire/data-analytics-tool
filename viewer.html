<html>
    <head>
        <meta charset="UTF-8">
        <!--JQuery-->
        <script src="https://code.jquery.com/jquery-latest.js"></script>
        <!--Ajax-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.js"></script>
        <!--Google charts-->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <!--Bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>                        
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">
        <!--HTML2PDF-->        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!-- jsPF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="js/OpenSans-Regular-normal.js"></script>
        <script type="text/javascript">
            document.write("<base href='" + window.location.origin + "' />");
        </script>
    <link href="/css/footer-viewer.css" rel="stylesheet" />
    <link href="/css/index.css" rel="stylesheet" />
        <style>
            .navbar-brand
            {
              font-size: 40px;
            }
            
            .treemaptooltip {
                background: white;
                z-index: 10;
                position: sticky;
            }
        </style>

        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <title>Data Analytics Tool - Viewer</title>
    </head>
    <body>    
        <div class="container-fluid main-container">
            <nav class="navbar navbar-light" id="dat-header">
                <a class="navbar-brand" href="/">
                    <img src="img/logo.png" height="50px"/> Data Analytics Tool
                </a>
            </nav>
            <div class="row my-3">
                <div class="col">
                    <h2>Data Analytics Viewer</h2>        
                </div>
            </div>



        <div class="row my-3">
            <div class="input-holder">
                <select name="corpora-selector" id="corpora-selector"  class="form-select"></select>
            </div>
            <div class="input-holder">
                <button id="load-button" class="btn btn-primary">Load corpus stats</button>
            </div>
        </div>
        
        <div id="the-content">
            <div id="text-content">
            <!-- NAME AND LANGUAGES -->
            <div class="row my-3">
                <h3>Corpus</h3>
            </div>            
            <div class="row mb-3">        
                <div class="label-holder bold">
                    <label class="form-label" for="corpus-name">Name</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="corpus-name" name="corpus-name"></span>
                </div>
                <div class="label-holder bold">
                    <label class="form-label" for="timestamp">Analytics date</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="timestamp" name="timestamp"></span>
                </div>
            </div>
            <div class="row my-3">
                <div class="label-holder bold">
                    <label class="form-label" for="slang">Source language</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="slang" name="slang"></span>
                </div>
                <div class="label-holder bold">
                    <label class="form-label" for="tlang">Target language</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="tlang" name="tlang"></span>
                </div>
            </div>
        
            <!-- VOLUMES -->
            <div class="row my-3">
                <h3>Volumes</h3>
            </div>
            <div class="row mb-3">
                <div class="label-holder bold">
                    <label class="form-label" for="sent-pairs">Segment pairs</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="sent-pairs" name="sent-pairs"></span>
                </div>
                <div class="label-holder bold">
                    <label class="form-label" for="src-bytes">Source size</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="src-bytes" name="src-bytes"></span>
                </div>
                <div class="parent-holder">
                <div class="label-holder bold">
                    <label class="form-label" for="trg-bytes">Target size</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="trg-bytes" name="trg-bytes"></span>
                </div>
            </div>
            </div>  
            <div class="row mb-3">
                <div class="label-holder bold">
                    <label class="form-label" for="sent-unique">Unique segment pairs</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="sent-unique" name="sent-unique"></span>
                </div>
                <div class="label-holder bold">
                    <label class="form-label" for="src-tokens">Source tokens</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="src-tokens" name="src-tokens"></span>
                </div>
                <div class="parent-holder">
                <div class="label-holder bold">
                    <label class="form-label" for="trg-tokens">Target tokens</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="trg-tokens" name="trg-tokens"></span>
                </div>
            </div>

            </div>
        
            <!-- TTR -->
            <div class="row my-3">
                <h3>Type-Token Ratio</h3>
            </div>
            <div class="row mb-3">
                <div class="label-holder bold">
                    <label class="form-label" for="src-ttr">Source</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="src-ttr" name="src-ttr"></span>
                </div>
                <div class="label-holder bold">
                    <label class="form-label" for="trg-ttr">Target</label>
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext" id="trg-ttr" name="trg-ttr"></span>
                </div>
            </div>
        </div> 
        <div>
            <!-- SENTENCE LENGHT HISTOGRAM -->
            <div class="row my-3" id="sentence-length-header">        
                <h3>Segment length distribution</h3>
            </div>
            <div class="row">
                <div class="col-6 inline" id="src-sentence-length-header">
                    <h4>Source</h4>
                </div>
                <div class="col-6 inline" id="trg-sentence-length-header">
                    <h4>Target</h4>
               </div>
            </div>
            <div class="row mb-3">
                <div class="col-6 inline">
                    <div id="src_token_chart_na">n/a</div>
                    <div id="src_token_chart"></div>
                </div>
                <div class="col-6 inline">
                    <div id="trg_token_chart_na">n/a</div>
                    <div id="trg_token_chart"></div>
                </div>
            </div>    
        
            <!-- LANGUAGE IDS CHARTS -->
            <div class="row my-3" id="language-distribution-header">
                <h3>Language distribution <i class="bi bi-info-circle" style="font-size: 0.7em;" title="Identified by FastSpell"></i></h3>                
            </div>
            <div class="row">
                <div class="col-6 inline" id="src-language-distribution-header">
                    <h4>Source</h4>                
                </div>
                <div class="col-6 inline" id="trg-language-distribution-header">
                    <h4>Target</h4>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-6 inline">
                    <div id="src_langs_chart_na">n/a</div>
                    <div id="src_langs_chart"></div>
                </div>
                <div class="col-6 inline">
                    <div id="trg_langs_chart_na">n/a</div>
                    <div id="trg_langs_chart"></div>
                </div>
            </div>

        
            <!-- BICLEANER SCORE HISTOGRAM -->
            <div class="row my-3" id="bicleaner-score-header">
                <h3>Bicleaner score distribution <i class="bi bi-info-circle" style="font-size: 0.7em;" title="Scores from 0 (lower quality segments) to 1 (higher quality segments)"></i></h3>
            </div>
            <div id="bicleaner_content">        
                <div class="row">
                    <div class="col">
                        <div id="bicleaner_scores_chart_na">n/a</div>
                        <div id="bicleaner_scores_chart"></div>                        
                    </div>
                </div>
                <div class="row my-3  alert alert-warning" role="alert" id="bicleaner-xx-warning">
                    <i class="bi bi-exclamation-triangle"></i> Scores obtained with Bicleaner multilingual model (en-xx), might not be accurate.
                </div>
            </div>        

            <!-- BICLEANER HARDRULES NOISE CHART -->
            <div class="row my-3" id="noise-distribution-header">
                <h3>Noise distribution <i class="bi bi-info-circle" style="font-size: 0.7em;" title="Identified by Bicleaner Hardrules"></i></h3>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <div id="hardrules-tags-na">n/a</div>
                    <div id="hardrules-tags"></div>
                </div>
            </div>
            
            
            <!-- NGRAMS -->
            <div class="row my-3" id="common-ngrams-header">
                <h3>Common n-grams</h3>
            </div>        
            <div class="row mb-3">
                <div class="col" id="src-common-ngrams-header">
                    <h4>Source</h4>
                </div> 
            </div>
            <div class="row mb-3">
                <div class="col-12">
                    <div id="src-ngrams-na">n/a</div>
                    <div id="src-ngrams"></div>
                </div>
                <div class="row my-3  alert alert-warning" role="alert" id="src-tokenizer-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
            </div>
        
            <div class="row mb-3">            
                <div class="col" id="trg-common-ngrams-header">
                    <h4>Target</h4>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-12">
                    <div id="trg-ngrams-na">n/a</div>
                    <div id="trg-ngrams"></div>
                </div>
            </div>
            <div class="row my-3  alert alert-warning" role="alert" id="trg-tokenizer-warning">
                <i class="bi bi-exclamation-triangle"></i>
           </div>
        </div>
        
        <div class="row my-3">
            <div class="col-auto">
                <a class="btn btn-primary disabled" id="download-yaml" href="#">Download yaml</a>
            </div>
            <div class="col-auto">
                <a class="btn btn-primary disabled" id="download-pdf">Export as PDF</a>
            </div>
            <div class="col-auto">
                <a class="btn btn-dark" href="./uploader.html">Go to uploader</a>
            </div>
        </div>
        <div class="footer">
            <div class="footer-text-left">
              <p class="hplt-copyright">Ⓒ HPLT 2023</p>
              <a
                href="https://cordis.europa.eu/project/id/101070350"
                class="horizon-link"
                target="_blank"
              >
                <img
                  src="img/horizon.svg"
                  alt="european-union-flag"
                  class="horizon-logo"
                />
              </a>
        
              <a href="https://www.ukri.org" class="ukri-link" target="_blank">
                <img src="/img/UKRIlogo.png" alt="ukri-logo" class="ukri-logo" />
              </a>
        
              <p class="footer-info">
                This project has received funding from the European Union’s Horizon
                Europe research and innovation programme under grant agreement No
                101070350 and from UK Research and Innovation (UKRI) under the UK
                government’s Horizon Europe funding guarantee [grant number 10052546]
              </p>
            </div>
            <div class="footer-text-middle">
              <img src="/img/eu-flag.png" alt="" class="eu-flag" />
              <p class="footer-info">
                The contents of this publication are the sole responsibility of the
                HPLT consortium and do not necessarily reflect the opinion of the
                European Union.
              </p>
            </div>
            <div class="footer-text-right">
              <a href="https://twitter.com/hplt_eu" target="_blank" rel="noreferrer">
                <img
                  src="/img/twitter.svg"
                  alt="twitter-icon"
                  class="twitter-icon-footer"
                />
              </a>
            </div>
          </div>
        

        <script>
        
            var chart_images = {
                src_length_histogram_img: "",
                trg_length_histogram_img: "",
                src_langid_img: "",
                trg_langid_img: "",
                score_distribution_img: "",
                noise_distribution_img: "",
                src_ngrams_obj: "",
                trg_ngrams_obj: ""
            }
            
            
            $(document).ready(function(){
                $("#the-content").css("display", "None")


                var select = $("#corpora-selector")
                $.ajax({
                    url: "/list",
                    success: function(data) {
                        var htmlOptions = [];
                        if (data.length){
                            data = JSON.parse(data)
                            for (item in data) {
                                html = '<option value="' + data[item] + '">' + data[item] + '</option>';
                                htmlOptions[htmlOptions.length] = html;
                          } 

                        // here you will empty the pre-existing data from you selectbox and will append the htmlOption created in the loop result
                        select.empty().append( htmlOptions.join('') );
                        }
                    },
                    error: function(error) {
                        alert(error.responseJSON.message);
                    }
                });           
            });
            
            
            const languageNames = new Intl.DisplayNames(['en'], {
                type: 'language'
            }); 
            
            $('#load-button').click(function(){
                load_data($("#corpora-selector").val());
                document.getElementById('download-yaml').href="/download/"+$("#corpora-selector").val();
            });
            
            function pixels_to_points(pixels) {
                return pixels*72/96;
            }
            
            $('#download-pdf').click(function(){
                dopdf_wrapper()                
            })
            
            async function dopdf_wrapper() {
                $("#download-pdf").addClass("disabled").prop("disabled", true);
                $("#download-pdf").html(
                    '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Building PDF...'
                );
                //console.log("in")
                await dopdf()
                $("#download-pdf").removeClass("disabled").prop("disabled", false);
                $("#download-pdf").html(
                    'Export as PDF'
                );
            };
            
            async function dopdf() {
                window.html2canvas = html2canvas;

                var margin_left = 30;
                var margin_top = 50;

                var current_y = margin_top;
                var cur_page = 1 
                
                //const { jsPDF } = window.jspdf;

                var doc = new jsPDF('p', 'pt', 'a4'); //orientation, units, format
                
                console.log('Show all font in jsPDF',doc.getFontList());

                var pageHeight = doc.internal.pageSize.getHeight();
                //doc.setFont("Helvetica")
                doc.setFont('OpenSans-Regular', 'normal');
                //doc.setFontType('normal');
                //Header
                await doc.html(document.getElementById("dat-header"), {
                     html2canvas: {
                        scale: 0.5
                    },
                    callback: function (doc) {
                        current_y = current_y + 50
                        return doc
                    },
                    x: margin_left,
                    y: pixels_to_points(current_y)
                });
                
                //Corpus, Volumes & TTR
                await doc.html(document.getElementById("text-content"),  {
                    html2canvas: {
                        scale: 0.5
                    },
                    callback: function (doc) { 
                        current_y = current_y + 400
                        return doc
                    },                    
                   x: margin_left,
                   y: pixels_to_points(current_y)
                });
                  
                //Length histograms
                if (chart_images["src_length_histogram_img"] != "" || chart_images["trg_length_histogram_img"] != "" ) {

                    await doc.html(document.getElementById("sentence-length-header"), {
                        html2canvas: {
                            scale: 0.5
                        },
                        callback: function (doc) {
                            current_y = current_y + 50
                            return doc
                        },
                        x: margin_left,
                        y: pixels_to_points(current_y),
                    });
                    if (chart_images["src_length_histogram_img"] != "") {
                        await doc.html(document.getElementById("src-sentence-length-header"), {
                            html2canvas: {
                                scale: 0.5
                            },
                            callback: function (doc) {
                                current_y = current_y + 50
                                doc.addImage(chart_images["src_length_histogram_img"], 'png', margin_left, pixels_to_points(current_y), pixels_to_points(700), pixels_to_points(200), "src_histogram");
                                current_y = current_y + 200;
                                return doc
                            },
                            x: margin_left,
                            y: pixels_to_points(current_y)
                        });
                    }                
                    
                    if (chart_images["trg_length_histogram_img"] != "") {
                        await doc.html(document.getElementById("trg-sentence-length-header"), {
                            html2canvas: {
                                scale: 0.5
                            },
                            callback: function (doc) {
                                current_y = current_y + 30
                                doc.addImage(chart_images["trg_length_histogram_img"], 'png', margin_left, pixels_to_points(current_y), pixels_to_points(700), pixels_to_points(200), "trg_histogram");
                                current_y = current_y + 200;
                                return doc
                            },
                            x: margin_left,
                            y: pixels_to_points(current_y)
                        });
                    }                    
                    current_y = current_y + 50
                }

                //Langid graphs
                if (chart_images["src_langid_img"] != "" || chart_images["trg_langid_img"] != "" ) {
                    if (pixels_to_points(current_y+300) > pageHeight) {
                        doc.addPage();
                        cur_page = cur_page +1
                        doc.setPage(cur_page)
                        current_y = margin_top // Restart height position
                    }
                    doc.setFontSize(18)
                    doc.text("Language distribution", margin_left, pixels_to_points(current_y))
                    current_y = current_y + 50
                                    
                    if (chart_images["src_langid_img"] != "") {
                        doc.setFontSize(16)
                        doc.text("Source", margin_left, pixels_to_points(current_y))
                        current_y = current_y + 30
                        doc.addImage(chart_images["src_langid_img"], 'png', margin_left, pixels_to_points(current_y), pixels_to_points(700), pixels_to_points(200), "src_langid");
                        current_y = current_y + 200;                    
                    }
                    if (pixels_to_points(current_y+300) > pageHeight) {
                        doc.addPage();
                        cur_page = cur_page +1
                        doc.setPage(cur_page)
                        current_y = margin_top // Restart height position
                    }
                    if (chart_images["trg_langid_img"] != "") {
                        doc.setFontSize(16)
                        doc.text("Target", margin_left, pixels_to_points(current_y))
                        current_y = current_y + 30
                        doc.addImage(chart_images["trg_langid_img"], 'png', margin_left, pixels_to_points(current_y), pixels_to_points(700), pixels_to_points(200), "trg_langid");
                        current_y = current_y + 200;                    
                    }                
                    current_y = current_y + 50
                }
                
                //{bi,mono}cleaner scores
                if (chart_images["score_distribution_img"] != "")  {
                    if (pixels_to_points(current_y+300) > pageHeight) {
                        doc.addPage();
                        cur_page = cur_page +1
                        doc.setPage(cur_page)
                        current_y = margin_top // Restart height position
                    }
                    doc.setFontSize(18)
                    doc.text("Bicleaner score distribution", margin_left, pixels_to_points(current_y))
                    current_y = current_y + 30                    
                    doc.addImage(chart_images["score_distribution_img"], 'png', margin_left, pixels_to_points(current_y), pixels_to_points(700), pixels_to_points(150), "scores"); 
                    current_y = current_y + 200;
                }
                
                //Hardrules
                if (chart_images["noise_distribution_img"] != "")  {
                    if (pixels_to_points(current_y+300) > pageHeight) {
                        doc.addPage();
                        cur_page = cur_page +1
                        doc.setPage(cur_page)
                        current_y = margin_top // Restart height position
                    }
                    doc.setFontSize(18)
                    doc.text("Noise distribution", margin_left, pixels_to_points(current_y))
                    current_y = current_y + 30 
                    doc.addImage(chart_images["noise_distribution_img"], 'png', margin_left, pixels_to_points(current_y), pixels_to_points(700), pixels_to_points(150), "noise"); 
                    current_y = current_y + 200;
                }
                
                if (pixels_to_points(current_y+200) > pageHeight) {
                   doc.addPage();
                   cur_page = cur_page +1
                   doc.setPage(cur_page)
                   current_y = margin_top // Restart height position
                }
                //ngrams
                if (chart_images["src_ngrams_obj"] != "" || chart_images["trg_ngrams_obj"] != "" ) {

                    doc.setFontSize(18)
                    doc.text("Common n-grams", margin_left, pixels_to_points(current_y))
                    current_y = current_y + 50

                    if (chart_images["src_ngrams_obj"] != "") {
                        doc.setFontSize(16)
                        doc.text("Source", margin_left, pixels_to_points(current_y))
                        current_y = current_y + 30
                        data_series = chart_images["src_ngrams_obj"] 
                        var last_key = 0;

                        for (const [key, value] of Object.entries(data_series)) {
                            if (pixels_to_points(current_y+200) > pageHeight) {
                                doc.addPage();
                                cur_page = cur_page +1
                                doc.setPage(cur_page)
                                current_y = margin_top // Restart height position
                            }
                            //key: ngram length
                            if (key != last_key){
                                doc.setFontSize(14)
                                doc.text("Length: " + key + " tokens", margin_left*2, pixels_to_points(current_y))
                                current_y = current_y + 30
                                last_key = key
                            }
                            //ngram_length = parseInt(key)
                            value.forEach(function(item) {
                                ngram_text = item[0].join(" ")
                                ngram_freq = parseInt(item[1])
                                doc.setFontSize(12)
                                doc.text(ngram_text + " (Freq: " + ngram_freq + ")", margin_left*3, pixels_to_points(current_y))
                                current_y = current_y + 20
                            });
                            current_y = current_y + 30
                        }
                        current_y = current_y + 50;
                    }
                    
                    if (pixels_to_points(current_y+200) > pageHeight) {
                        doc.addPage();
                        cur_page = cur_page +1
                        doc.setPage(cur_page)
                        current_y = margin_top // Restart height position
                    }
                    
                    if (chart_images["trg_ngrams_obj"] != "") {
                        doc.setFontSize(16)
                        doc.text("Target", margin_left, pixels_to_points(current_y))
                        current_y = current_y + 30
                        data_series = chart_images["trg_ngrams_obj"] 
                        var last_key = 0;
                        for (const [key, value] of Object.entries(data_series)) {
                            if (pixels_to_points(current_y+200) > pageHeight) {
                                doc.addPage();
                                cur_page = cur_page +1
                                doc.setPage(cur_page)
                                current_y = margin_top // Restart height position
                            }
                            //key: ngram length
                            if (key != last_key){
                                doc.setFontSize(14)
                                doc.text("Length: " + key + " tokens", margin_left*2, pixels_to_points(current_y))
                                current_y = current_y + 30
                                last_key = key
                            }
                            //ngram_length = parseInt(key)
                            value.forEach(function(item) {
                                ngram_text = item[0].join(" ")
                                ngram_freq = parseInt(item[1])
                                doc.setFontSize(12)
                                doc.text(ngram_text + " (Freq: " + ngram_freq + ")", margin_left*3, pixels_to_points(current_y))
                                current_y = current_y + 20
                            });
                            current_y = current_y + 30
                        }
                        current_y = current_y + 50;
                    }

                }             
            doc.save($("#corpus-name").text()+".pdf")
            //window.open(doc.output('bloburl'));
            }

            google.charts.load('current', {'packages':['corechart', 'bar', 'treemap']});

            function getColor(value){
                //value from 0 to 1
                var hue=((value)*120).toString(10);
                return ["hsl(",hue,",100%,50%)"].join("");
            }            
            
            
            function beautify_hr_labels(raw_label) {
                switch (raw_label){
                    case "not_too_long":
                        return "Too long"
                    case "not_too_short":
                        return "Too short"
                    case "no_urls":
                        return "URLs"
                    case "no_bad_encoding":
                        return "Bad encoding"
                    case "no_porn":
                        return "Porn"
                    default:
                        return raw_label
                }
            }
            
            
            function draw_histogram(div_id, data_series, chart_title, x_axis_label, y_axis_label, img) {
                // Create the data table.
                var data = new google.visualization.DataTable();
                data.addColumn('string', x_axis_label);
                data.addColumn('number', y_axis_label);
                data_series = JSON.parse(data_series)                                
                high_values = 0
                max_v_value = 10
                data_series.forEach(function(item) {
                    if (item[0] < 100){
                        if (item[1] > max_v_value){
                            max_v_value = item[1]
                        }
                        data.addRow([item[0].toString(), item[1]]) 
                        }
                    else {
                        if (item[1] > max_v_value){
                            max_v_value = item[1]
                        }
                        high_values = high_values + item[1]
                    }
                });
                if (high_values > 0) {
                    data.addRow(["100+", high_values])
                }
                // Set chart options
                var options = {
                    //title: chart_title,
                    hAxis: {
                        title: data.getColumnLabel(0)
                        },                    
                    vAxis: {
                        title: data.getColumnLabel(1),
                        viewWindowMode: "explicit",   
                        viewWindow: {
                            max: max_v_value,
                            min:0  
                        }
                    },
                    legend: 'none'
                };
                //var materialChart = new google.charts.Bar(document.getElementById(div_id));
                var materialChart = new google.visualization.ColumnChart(document.getElementById(div_id));
                materialChart.draw(data, options);
                chart_images[img] = materialChart.getImageURI();
            }           
  

            
            function draw_stacked_histogram(div_id, data_series_totals, data_series_unique,  chart_title, x_axis_label, y_axis_label, img, mean, median) {
                // Create the data table.
                var data = new google.visualization.DataTable();
                data.addColumn('string', "Segment length (tokens)");
                data.addColumn('number', "Segments");
                data.addColumn({type: 'string', role: 'tooltip', 'p': {'html': true}});
                data.addColumn('number', "Duplicated segments");
                data.addColumn({type: 'string', role: 'tooltip', 'p': {'html': true}});
                data.addColumn({role: 'annotation', type: 'string'})
                data.addColumn({role: 'annotation', type: 'string'})
                
                //data.addColumn("number", "Mean")
                //data.addColumn("number", "Median")

                                
                data_series_totals = JSON.parse(data_series_totals)
                data_series_unique = JSON.parse(data_series_unique)
                high_values_total = 0
                high_values_uniq = 0
                high_values_dupes = 0
                max_x = 0
                data_series_totals.forEach(function(item, index) {
                    token_length = item[0]
                    total =  item[1]
                    if (total >= max_x) {
                        max_x = total
                    }
                    uniq_full_item = data_series_unique[index];
                    uniq = 0
                    
                    if (uniq_full_item) {
                        uniq = uniq_full_item[1]
                    }
                        
                    dupes = total - uniq
                    
                    mean_here = null
                    median_here = null
                    
                    if (token_length == mean){
                        //mean_here = max_x
                        mean_here = "MEAN"
                    }
                    if (token_length == median){
                        //median_here = max_x
                        median_here = "MEDIAN"
                    }
                        
                    if (token_length < 100){                   
                        
                            data.addRow([token_length.toString(),
                            uniq,
                            "<b>Length:</b> " + token_length + " tokens<br>" + "<b>Total:</b> " +  total.toLocaleString() + "<br><b>Unique:</b> " + uniq.toLocaleString()  + "<br><b>Duplicates:</b> " + dupes.toLocaleString(),
                            dupes,
                            "<b>Length:</b> " + token_length + " tokens<br>" + "<b>Total:</b> " +  total.toLocaleString() + "<br><b>Unique:</b> " + uniq.toLocaleString()  + "<br><b>Duplicates:</b> " + dupes.toLocaleString(),
                            mean_here,
                            median_here]) 
                    }                    
                    else {
                        high_values_total = high_values_total + total
                        high_values_uniq = high_values_uniq + uniq
                        high_values_dupes = high_values_dupes + dupes
                    }
                });
                
                if (high_values_total > 0) {
                    data.addRow(["100+", 
                    high_values_uniq,
                    "<b>Length:</b> 100+ tokens<br>" + "<b>Total:</b> " +  high_values_total.toLocaleString() + "<br><b>Unique:</b> "+  high_values_uniq.toLocaleString() + "<br><b>Duplicates:</b> " + high_values_dupes.toLocaleString(), 
                    high_values_dupes,
                    "<b>Length:</b> 100+ tokens<br>" + "<b>Total:</b> " +  high_values_total.toLocaleString() + "<br><b>Unique:</b> "+  high_values_uniq.toLocaleString() +  "<br><b>Duplicates:</b> "+ high_values_dupes.toLocaleString(), null, null]) 

                }
                
                //data.addRow(["30", max_x, null, null, null, "MEDIAN"])
                
                
                // Set chart options
                var options = {
                    //title: chart_title,
                    hAxis: {
                        title: "Segment length (tokens)"
                         },     
                    vAxis: {
                        title: data.getColumnLabel(1)
                        },
                    tooltip: {
                        isHtml: true
                    },
                    seriesType:'bars',
                    isStacked: true,
                    legend: 'none',
                    /*
                    series: {
                       2 : {
                            color: 'green',
                            type: 'line'                
                        },
                        3: {
                            color: 'pink',
                            type: 'line'
                        }            
                    },
                    */
                    annotations: {
                        stem: {
                            color: 'green'
                        },
                      style: 'line'
                    },
                };
                var materialChart = new google.visualization.ComboChart(document.getElementById(div_id));
                materialChart.draw(data, options);
                chart_images[img] = materialChart.getImageURI();
            }
            
            function draw_horizontal_bars(div_id, data_series, chart_title, x_axis_label, y_axis_label, img) {
                var data = new google.visualization.DataTable();
                data.addColumn('string', y_axis_label);
                data.addColumn('number', x_axis_label);
                data_series = JSON.parse(data_series)

                for (const [key, value] of Object.entries(data_series)) {
                    data.addRow([beautify_hr_labels(key.toString()), value])
                }

                var options = {
                    //title: chart_title,
                    hAxis: {
                        title: x_axis_label,
                        viewWindowMode:'explicit',
                        viewWindow:{
                            max:0.0,
                            min:100
                            }                        
                        },
                    vAxis: {
                        title: y_axis_label
                        },
                    legend: 'none'
                }
                var chart = new google.visualization.BarChart(document.getElementById(div_id));
                chart.draw(data, options);
                chart_images[img] = chart.getImageURI();

            }
            
            function draw_pie(div_id, data_series, chart_title, img) {
                var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Language');
                    data.addColumn('number', 'Frequency');
                    data_series = JSON.parse(data_series)
                    data_series.forEach(function(item) {
                        data.addRow([languageNames.of(item[0]), item[1]])                    
                    });
                
                var options = {} //'title': chart_title}
                var materialChart = new google.visualization.PieChart(document.getElementById(div_id));
                materialChart.draw(data, options);
                chart_images[img] = materialChart.getImageURI();
            }
            
            function draw_ngrams(div_id, data_series, img) {
                var data = new google.visualization.DataTable();
                //data.addColumn("string", "ngram")
                data.addColumn({type: "number", label:"Frequency"}) //x axis
                data.addColumn({type: "number", label: "ngram length"}) //y axis
                data.addColumn({type: "string", label:"ngram_1", role: "annotation"})
                data.addColumn({type: "string", label: "ngram_2", role: "annotationText"})
                data.addColumn({type: "string", label: "ngram_3", role: "tooltip"})

                data_series = JSON.parse(data_series)
                for (const [key, value] of Object.entries(data_series)) {
                    //key: ngram length
                    ngram_length = parseInt(key)
                    value.forEach(function(item) {                    
                        ngram_text = item[0].join(" ")
                        ngram_freq = parseInt(item[1])
                        //data.addRow([ngram_length, ngram_freq])
                        data.addRow([ngram_freq, ngram_length, ngram_text,
                        ngram_text, ngram_text]);
                    });
                }
                chart_images[img] = data_series
                options = {
                    vAxis: {
                        title: 'ngram length',
                        minValue: 0,
                        maxValue: 3
                    },
                    hAxis: {
                        title: 'Frequency'
                    },
                    legend: 'none',
                    annotations: {
                        'ngram_1': {
                            style:'line'
                        }
                    }
                }
                                
                //var chart = new google.visualization.BubbleChart(document.getElementById(div_id));
                //chart.draw(data, options);
                
                var chart = new google.visualization.ScatterChart(document.getElementById(div_id));
                chart.draw(data, options);
                chart_images[img] = chart.getImageURI();
            }
            
            function draw_treemap(div_id, data_series, img) {
                var data = new google.visualization.DataTable();
                data.addColumn({type: "string", label: "ngram"}); //id
                data.addColumn({type: "string", label: "group"}); //parent
                data.addColumn({type: "number", label: "frequency"}); //node size
                //data.addColumn({type: "number", label: "group"}); //color config

                
                data_series = JSON.parse(data_series)
                chart_images[img] = data_series
                data.addRow(["ngrams", null, 0])
                data.addRow(["1", "ngrams", 0])
                data.addRow(["2", "ngrams", 0])
                data.addRow(["3", "ngrams", 0])
                data.addRow(["4", "ngrams", 0])
                data.addRow(["5", "ngrams", 0])
                for (const [key, value] of Object.entries(data_series)) {
                    ngram_length = parseInt(key)
                    value.forEach(function(item) {
                        ngram_text = item[0].join(" ")
                        ngram_freq = parseInt(item[1])                    
                        data.addRow([ngram_text, ngram_length.toString(), ngram_freq])
        
                    });
                }
                options = {
                    maxDepth: 2,
                    generateTooltip: showTreemapTooltip,
                    allowHtml: true,
                    minColor: 'thistle',
                    midColor: 'mediumslateblue',
                    maxColor: 'slateblue'
//                    minColor: 'powderblue',
//                    minColor: 'orangered',                        
//                    midColor: 'dodgerblue',
 //                    midColor: 'gold',
//                   maxColor: 'mediumblue'
 //                     maxColor: 'green'
                }
                var chart = new google.visualization.TreeMap(document.getElementById(div_id));
                chart.draw(data, options);
                //img = chart.getImageURI();

                function showTreemapTooltip(row, size, value){
                    return "<div class=\"treemaptooltip\">"+data.getValue(row, 0)+"<br>"+ "Frequency: " +
                    data.getValue(row, 2)+"</div>"
                }
                
            }
            

            function load_data(corpus){
                $.get("/file/"+corpus, function(text) {
                    var obj = jsyaml.load(text)
                    chart_images = {
                        src_length_histogram_img: "",
                        trg_length_histogram_img: "",
                        src_langid_img: "",
                        trg_langid_img: "",
                        score_distribution_img: "",
                        noise_distribution_img: "",
                        src_ngrams_obj: "",
                        trg_ngrams_obj : ""
                    }
                    $("#the-content").css("display", "block")
                    $("#download-yaml").removeClass("disabled")
                    $("#download-pdf").removeClass("disabled")
                    
                    if ("corpus" in obj) {                        
                        corpusname = obj["corpus"]
                        $("#corpus-name").html(corpusname)
                    }
                    else {
                        $("#corpus-name").html("n/a")
                    }
                    
                    if ("timestamp" in obj) {
                        timestamp_ms = obj["timestamp"]
                        timestamp_secs = timestamp_ms*1000
                        d = new Date(timestamp_secs)
                        
                        $("#timestamp").html(d.toLocaleString())
                    }
                    else {
                        $("#timestamp").html("n/a")
                    }
                    
                    if ("srclang" in obj) {
                        slang = obj["srclang"]
                        $("#slang").html(languageNames.of(slang) + " (" + slang +")" )
                    }
                    else {
                         $("#slang").html("n/a")
                    }
                    
                    if ("trglang" in obj) {
                        tlang = obj["trglang"]
                        $("#tlang").html(languageNames.of(tlang) + " (" + tlang + ")" )
                    }
                    else {
                         $("#tlang").html("n/a")
                    }
                    if ("sentence_pairs" in obj) {
                        sentpairs = obj["sentence_pairs"]
                        $("#sent-pairs").html(sentpairs.toLocaleString())
                    }
                    else {
                        $("#sent-pairs").html("n/a")
                    }
                    
                    if ("unique_sents" in obj) {
                        unique_sents = obj["unique_sents"]
                        $("#sent-unique").html(unique_sents.toLocaleString())
                    }
                    else {
                        $("#sent-unique").html("n/a")
                    }
                    
                    if ("src_tokens" in obj) {
                        src_tokens = obj["src_tokens"]
                        $("#src-tokens").html(src_tokens.toLocaleString())
                    }
                    else {
                        $("#src-tokens").html("n/a")
                    }
                    
                    if ("trg_tokens" in obj) {
                        trg_tokens = obj["trg_tokens"]
                        $("#trg-tokens").html(trg_tokens.toLocaleString())
                    }
                    else {
                        $("#trg-tokens").html("n/a")
                    }                   
                    
                    if ("src_sent_tokens" in obj){
                        src_token_distribution = obj["src_sent_tokens"]
                        if ("src_unique_sents" in obj) {
                            src_unique_distribution = obj["src_unique_sents"]
                            src_mean = null
                            src_median = null
                            if ("src_sent_tokens_mean" in obj) {
                                src_mean = obj["src_sent_tokens_mean"]
                            }
                            if ("src_sent_tokens_median" in obj) {
                                src_median = obj["src_sent_tokens_median"]
                            }
                            
                            draw_stacked_histogram("src_token_chart", src_token_distribution, src_unique_distribution, "Total and unique source segments per length (tokens)", "Tokens", "Frequency", "src_length_histogram_img", src_mean, src_median)
                        }
                        else {
                            draw_histogram("src_token_chart", src_token_distribution, "Source segments length (tokens)", "Tokens", "Frequency", "src_length_histogram_img")
                        }
                        $("#src_token_chart_na").css("display" , "none")
                        $("#src_token_chart").css("visibility", "visible")
                    }
                    else {
                        $("#src_token_chart_na").css("display" , "block")
                        $("#src_token_chart").css("visibility", "collapse")
                    }
                    
                    if ("trg_sent_tokens" in obj) {
                        trg_token_distribution = obj["trg_sent_tokens"]
                        if ("trg_unique_sents" in obj) {
                            trg_unique_distribution =  obj["trg_unique_sents"]
                            trg_mean = null
                            trg_median = null
                            if ("trg_sent_tokens_mean" in obj) {
                                trg_mean = obj["trg_sent_tokens_mean"]
                            }
                            if ("trg_sent_tokens_median" in obj){
                                trg_median = obj["trg_sent_tokens_median"]
                            }
                            draw_stacked_histogram("trg_token_chart", trg_token_distribution, trg_unique_distribution, "Total and unique target segments per length (tokens)", "Tokens", "Frequency", "trg_length_histogram_img", trg_mean, trg_median)
                        }
                        else{
                            draw_histogram("trg_token_chart", trg_token_distribution, "Target segments length (tokens)", "Tokens", "Frequency", "trg_length_histogram_img")
                        }
                        $("#trg_token_chart_na").css("display" , "none")
                        $("#trg_token_chart").css("visibility", "visible")
                    }
                    else {
                        $("#trg_token_chart_na").css("display" , "block")
                        $("#trg_token_chart").css("visibility", "collapse")
                    }
                    
                    if ("src_langs" in obj) {
                        src_langs_distribution = obj["src_langs"]
                        draw_pie("src_langs_chart", src_langs_distribution, "Source segments identified language", "src_langid_img")
                        $("#src_langs_chart_na").css("display" , "none")
                        $("#src_langs_chart").css("visibility", "visible")
                    }
                    else {
                        $("#src_langs_chart_na").css("display" , "block")
                        $("#src_langs_chart").css("visibility", "collapse")
                    }
                    
                    if ("trg_langs" in obj) {
                        trg_langs_distribution = obj["trg_langs"]
                        draw_pie("trg_langs_chart", trg_langs_distribution, "Target segments identified language", "trg_langid_img")
                        $("#trg_langs_chart_na").css("display" , "none")
                        $("#trg_langs_chart").css("visibility", "visible")
                    }
                    else {
                        $("#trg_langs_chart_na").css("display" , "block")
                        $("#trg_langs_chart").css("visibility", "collapse")
                    }
                    
                    if ("bicleaner_scores" in obj || "monocleaner_scores" in obj) {
                        $("#bicleaner-xx-warning").css("display", "none")
                        if ("warnings" in obj) {
                            if (obj["warnings"].includes("bicleaner_xx")) {
                                $("#bicleaner-xx-warning").css("display", "block")
                            }
                        }
                        
                        if ("bicleaner_scores" in obj) {
                            scores_distribution = obj["bicleaner_scores"]
                        }
                        else {
                            scores_distribution = obj["monocleaner_scores"]
                        }
                        draw_histogram("bicleaner_scores_chart", scores_distribution, "Bicleaner scores", "Score range", "Frequency", "score_distribution_img") 
                        $("#bicleaner_scores_chart").css("visibility", "visible")
                        $("#bicleaner_scores_chart_na").css("display", "none")
                    }
                    else {
                        $("#bicleaner_scores_chart").css("visibility", "collapse")
                        $("#bicleaner_scores_chart_na").css("display", "block")
                        $("#bicleaner-xx-warning").css("display", "none")
                    }
                    
                    if ("src_bytes" in obj) {
                        source_bytes = obj["src_bytes"]
                        $("#src-bytes").html(source_bytes)
                    }
                    else {
                        $("#src-bytes").html("n/a")
                    }
                    
                    if ("trg_bytes" in obj) {
                        target_bytes = obj["trg_bytes"]
                        $("#trg-bytes").html(target_bytes)
                    }
                    else {
                        $("#trg-bytes").html("n/a")
                    }
                    
                    if ("hardrules_tags" in obj) {
                        hardrules_tags = obj["hardrules_tags"]
                        draw_horizontal_bars("hardrules-tags", hardrules_tags,"Bicleaner hardrules",  "% of corpus", "Noise type", "noise_distribution_img")
                        $("#hardrules-tags-na").css("display" , "none")
                        $("#hardrules-tags").css("visibility", "visible")
                    }
                    else {
                        $("#hardrules-tags-na").css("display" , "block")
                        $("#hardrules-tags").css("visibility", "collapse")
                    }
                    
                    if ("src_ngrams" in obj) {
                        /*if ("warnings" in obj) {
                            for w in obj["warnings"]{
                                if (w.startsWith("tok_")
                                    $("#src-tok-warning").css("display", "block")
                                }
                            }
                        }*/
                        src_ngrams = obj["src_ngrams"]
                        draw_treemap("src-ngrams", src_ngrams, "src_ngrams_obj")  
                        $("#src-ngrams-na").css("display" , "none")
                        $("#src-ngrams").css("visibility", "visible")         
                        $("#src-tokenizer-warning").css("display", "none")
                    }
                    else {
                        $("#src-ngrams-na").css("display" , "block")
                        $("#src-ngrams").css("visibility", "collapse")
                        $("#src-tokenizer-warning").css("display", "none")

                    }
                    
                    if ("trg_ngrams" in obj) {
                        trg_ngrams = obj["trg_ngrams"]
                         draw_treemap("trg-ngrams", trg_ngrams, "trg_ngrams_obj")
                        $("#trg-ngrams-na").css("display" , "none")
                        $("#trg-ngrams").css("visibility", "visible")
                        $("#trg-tokenizer-warning").css("display", "none")
                        
                    }
                    else {
                        $("#trg-ngrams-na").css("display" , "block")
                        $("#trg-ngrams").css("visibility", "collapse")
                        $("#trg-tokenizer-warning").css("display", "none")

                    }
                    
                    if ("ttr_src" in obj) {
                        src_ttr = obj["ttr_src"]
                        $("#src-ttr").html(src_ttr)
                        $('#src-ttr').css("color", getColor(src_ttr))
                    }
                    else {
                        $("#src-ttr").html("n/a")
                        $("#src-ttr").css("color", "inherit")

                    }
                    
                    if ("ttr_trg" in obj) {
                        trg_ttr = obj["ttr_trg"]
                        $("#trg-ttr").html(trg_ttr)
                        $("#trg-ttr").css("color", getColor(trg_ttr))
                    }
                    else {
                        $("#trg-ttr").html("n/a")
                        $("#trg-ttr").css("color", "inherit")
                    }
                });


//                $(window).resize(function(){
//     const width = $(window).width();
//    if(width%10 == 0 ) {
//     load_data($("#corpora-selector").val());
//                     document.getElementById('download-yaml').href="/download/"+$("#corpora-selector").val();

//    }
                
// });
            }
        </script>
 
    </body>
</html>

